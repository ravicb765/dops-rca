
# Shared logging configuration
x-logging: &logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

# Shared healthcheck for PostgreSQL dependencies
x-postgres-healthcheck: &postgres-healthcheck
  test: ["CMD-SHELL", "pg_isready -U postgres"]
  interval: 5s
  timeout: 5s
  retries: 10
  start_period: 10s

services:
  # ==========================================
  # PostgreSQL - Dual Database (Backstage + ZITADEL)
  # ==========================================
  postgres:
    image: postgres:17-alpine
    container_name: backstage-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: backstage
      # Performance tuning
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_MAX_CONNECTIONS: 200
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-postgres.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck: *postgres-healthcheck
    <<: *logging
    networks:
      - backstage-network

  # ==========================================
  # VictoriaMetrics - Unified Metrics + Logs
  # ==========================================
  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.135.0
    container_name: backstage-victoriametrics
    ports:
      - "8428:8428"  # Metrics HTTP API
      - "2003:2003"  # Graphite
    command:
      # Metrics configuration
      - "-httpListenAddr=:8428"
      - "-retentionPeriod=7d"
      - "-selfScrapeInterval=10s"
      - "--storageDataPath=/storage"
          
      # Performance
      - "-search.maxConcurrentRequests=1"
      - "-insert.maxQueueDuration=5m"
      - "-search.maxUniqueTimeseries=2028736"
      
      # Logging
      - "-loggerFormat=json"
      - "-loggerLevel=INFO"
    volumes:
      - victoriametrics-data:/storage
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8428/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    <<: *logging
    networks:
      - backstage-network

  # ==========================================
  # VictoriaLogs - Log Management
  # ==========================================
  victorialogs:
    image: victoriametrics/victoria-logs:v1.45.0
    container_name: backstage-victorialogs
    ports:
      - "9428:9428"
    command:
      - "-httpListenAddr=:9428"
      - "-storageDataPath=/storage"
      - "-loggerFormat=json"
    volumes:
      - victorialogs-data:/storage
    networks:
      - backstage-network

  # ==========================================
  # Mock Kubernetes API (Development Only)
  # ==========================================
  mock-k8s:
    build:
      context: ./mock-k8s
      dockerfile: Dockerfile
    container_name: backstage-mock-k8s
    ports:
      - "8081:8080"
    environment:
      LOG_LEVEL: info
      SIMULATE_FLUX_RECONCILIATION: "true"
      NAMESPACES: "team-a-prod,team-a-staging,team-b-prod,team-b-staging,platform-tools,monitoring"
    volumes:
      - ./mock-k8s/data:/app/data:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 3s
      retries: 3
    <<: *logging
    networks:
      - backstage-network

  # ==========================================
  # Backstage - Main Application
  # ==========================================
  backstage:
    build:
      context: .
      dockerfile: packages/backend/Dockerfile.dev.corepack
      args:
        USER_ID: ${UID:-1000}
        GROUP_ID: ${GID:-1000}
    container_name: backstage-app
    ports:
      - "3000:3000"  # Frontend
      - "7007:7007"  # Backend API
    volumes:
      # Source code (for hot-reload in dev)
      - .:/app:cached
      
      # Kubernetes config (optional)
      - ~/.kube:/home/node/.kube:ro
      
      # AWS credentials (optional)
      - ~/.aws:/home/node/.aws:ro
    command: >
      sh -c "
        YARN_ENABLE_IMMUTABLE_INSTALLS=false yarn install &&
        yarn workspace backend start
      "
    environment:
      # Node environment
      NODE_ENV: development
      NODE_OPTIONS: "--max-old-space-size=4096"
      
      # Backstage URLs
      APP_CONFIG_app_baseUrl: http://localhost:3000
      APP_CONFIG_backend_baseUrl: http://localhost:7007
      
      # Kubernetes plugin
      APP_CONFIG_kubernetes_serviceLocatorMethod_type: multiTenant
      APP_CONFIG_kubernetes_clusterLocatorMethods_0_type: config
      APP_CONFIG_kubernetes_clusterLocatorMethods_0_clusters_0_name: local-mock
      APP_CONFIG_kubernetes_clusterLocatorMethods_0_clusters_0_url: http://mock-k8s:8080
      APP_CONFIG_kubernetes_clusterLocatorMethods_0_clusters_0_authProvider: serviceAccount
      APP_CONFIG_kubernetes_clusterLocatorMethods_0_clusters_0_skipTLSVerify: true
      
      # VictoriaMetrics/VictoriaLogs
      APP_CONFIG_victoriametrics_metricsUrl: http://victoriametrics:8428
      APP_CONFIG_victoriametrics_logsUrl: http://victorialogs:9428
      APP_CONFIG_victoriametrics_queryPath: /select/logsql/query
      APP_CONFIG_victoriametrics_insertPath: /insert/jsonline
      
      # PostgreSQL
      APP_CONFIG_backend_database_connection_host: postgres
      APP_CONFIG_backend_database_connection_port: 5432
      APP_CONFIG_backend_database_connection_user: postgres
      APP_CONFIG_backend_database_connection_password: postgres
      APP_CONFIG_backend_database_connection_database: backstage
      
      # Permission policy
      APP_CONFIG_permission_enabled: true
      APP_CONFIG_permission_kubernetes_sharedNamespaces_0: monitoring
      APP_CONFIG_permission_kubernetes_sharedNamespaces_1: platform-tools
      APP_CONFIG_permission_kubernetes_sharedNamespaces_2: flux-system
      APP_CONFIG_permission_kubernetes_enableAuditLogging: true
      APP_CONFIG_permission_kubernetes_strictMode: true
      
      # Hot-reload (development)
      CHOKIDAR_USEPOLLING: "true"
      WATCHPACK_POLLING: "true"
    depends_on:
      postgres:
        condition: service_healthy
      victoriametrics:
        condition: service_started
      victorialogs:
        condition: service_started
      mock-k8s:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:7007/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    <<: *logging
    networks:
      - backstage-network

# ==========================================
# Volumes
# ==========================================
volumes:
  postgres-data:
    driver: local
  victoriametrics-data:
    driver: local
  victorialogs-data:
    driver: local

# ==========================================
# Networks
# ==========================================
networks:
  backstage-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
