version: '3.8'

# Shared logging configuration
x-logging: &logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

# Shared healthcheck for PostgreSQL dependencies
x-postgres-healthcheck: &postgres-healthcheck
  test: ["CMD-SHELL", "pg_isready -U postgres"]
  interval: 5s
  timeout: 5s
  retries: 10
  start_period: 10s

services:
  # ==========================================
  # PostgreSQL - Dual Database (Backstage + ZITADEL)
  # ==========================================
  postgres:
    image: postgres:15-alpine
    container_name: backstage-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: backstage
      # Performance tuning
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_MAX_CONNECTIONS: 200
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-postgres.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck: *postgres-healthcheck
    <<: *logging
    networks:
      - backstage-network

  # ==========================================
  # ZITADEL - Identity Provider (OIDC)
  # ==========================================
  zitadel:
    image: ghcr.io/zitadel/zitadel:v2.47.8
    container_name: backstage-zitadel
    ports:
      - "8080:8080"
    command: >
      start-from-init
      --masterkey="DevMasterKeyMustBe32Chars!!"
      --tlsMode=disabled
      --devMode=true
      --firstUserOrg="backstage-dev"
      --firstUserName="zitadel-admin"
      --firstUserEmail="admin@backstage-dev.local"
      --firstUserPassword="SuperSecureDevPass123!"
    environment:
      # Database connection
      ZITADEL_DATABASE_POSTGRES_HOST: postgres
      ZITADEL_DATABASE_POSTGRES_PORT: 5432
      ZITADEL_DATABASE_POSTGRES_USER: postgres
      ZITADEL_DATABASE_POSTGRES_PASSWORD: postgres
      ZITADEL_DATABASE_POSTGRES_DATABASE: zitadel
      ZITADEL_DATABASE_POSTGRES_SSL_MODE: disable
      
      # Logging
      ZITADEL_LOG_LEVEL: info
      ZITADEL_LOG_FORMAT: json
      
      # Development mode
      ZITADEL_DEV_MODE: "true"
      ZITADEL_EXTERNALSECURE: "false"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--spider", "http://localhost:8080/debug/ready"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s
    <<: *logging
    networks:
      - backstage-network

  # ==========================================
  # ZITADEL Initialization - OIDC App Setup
  # ==========================================
  zitadel-init:
    image: curlimages/curl:8.5.0
    container_name: backstage-zitadel-init
    depends_on:
      zitadel:
        condition: service_healthy
    volumes:
      - ./scripts:/scripts:ro
      - ./:/app
    environment:
      ZITADEL_URL: http://zitadel:8080
      ZITADEL_ADMIN_USER: zitadel-admin
      ZITADEL_ADMIN_PASS: SuperSecureDevPass123!
      ZITADEL_ORG: backstage-dev
      ZITADEL_PROJECT: backstage-local
      ZITADEL_APP: backstage-oidc
    command: >
      sh -c "
        apk add --no-cache jq bash &&
        chmod +x /scripts/zitadel-init.sh &&
        /scripts/zitadel-init.sh
      "
    <<: *logging
    networks:
      - backstage-network

  # ==========================================
  # VictoriaMetrics - Unified Metrics + Logs
  # ==========================================
  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.96.0
    container_name: backstage-victoriametrics
    ports:
      - "8428:8428"  # Metrics HTTP API
      - "9428:9428"  # Logs HTTP API
      - "2003:2003"  # Graphite
    command:
      # Metrics configuration
      - "-httpListenAddr=:8428"
      - "-retentionPeriod=7d"
      - "-selfScrapeInterval=10s"
      
      # Logs configuration (VictoriaLogs)
      - "-vlPublicUrl=http://victoriametrics:9428"
      - "-vlStorageDataPath=/storage/logs"
      - "-vlRetentionPeriod=7d"
      - "-vlMaxDailySeries=100000"
      - "-vlMaxHourlySeries=10000"
      
      # Performance
      - "-search.maxConcurrentRequests=12"
      - "-insert.maxQueueDuration=5m"
      
      # Logging
      - "-loggerFormat=json"
      - "-loggerLevel=INFO"
    volumes:
      - victoriametrics-data:/storage
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8428/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    <<: *logging
    networks:
      - backstage-network

  # ==========================================
  # Mock Kubernetes API (Development Only)
  # ==========================================
  mock-k8s:
    build:
      context: ./mock-k8s
      dockerfile: Dockerfile
    container_name: backstage-mock-k8s
    ports:
      - "8081:8080"
    environment:
      LOG_LEVEL: info
      SIMULATE_FLUX_RECONCILIATION: "true"
      NAMESPACES: "team-a-prod,team-a-staging,team-b-prod,team-b-staging,platform-tools,monitoring"
    volumes:
      - ./mock-k8s/data:/app/data:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 3s
      retries: 3
    <<: *logging
    networks:
      - backstage-network

  # ==========================================
  # Backstage - Main Application
  # ==========================================
  backstage:
    build:
      context: .
      dockerfile: packages/backend/Dockerfile.dev
      args:
        USER_ID: ${UID:-1000}
        GROUP_ID: ${GID:-1000}
    container_name: backstage-app
    ports:
      - "3000:3000"  # Frontend
      - "7007:7007"  # Backend API
    volumes:
      # Source code (for hot-reload in dev)
      - .:/app:cached
      - /app/node_modules
      
      # Kubernetes config (optional)
      - ~/.kube:/home/node/.kube:ro
      
      # AWS credentials (optional)
      - ~/.aws:/home/node/.aws:ro
    environment:
      # Node environment
      NODE_ENV: development
      NODE_OPTIONS: "--max-old-space-size=4096"
      
      # Backstage URLs
      APP_CONFIG_app_baseUrl: http://localhost:3000
      APP_CONFIG_backend_baseUrl: http://localhost:7007
      
      # Authentication
      APP_CONFIG_auth_environment: development
      APP_CONFIG_auth_providers_zitadel_development_clientId: ${ZITADEL_CLIENT_ID:-local-backstage-dev}
      APP_CONFIG_auth_providers_zitadel_development_clientSecret: ${ZITADEL_CLIENT_SECRET:-dev-secret-123}
      APP_CONFIG_auth_providers_zitadel_development_baseUrl: http://host.docker.internal:8080
      APP_CONFIG_auth_providers_zitadel_development_callbackUrl: http://localhost:3000/api/auth/zitadel/handler/frame
      
      # Group synchronization
      APP_CONFIG_auth_providers_zitadel_roleClaimPath: "urn:zitadel:iam:org:project:roles"
      APP_CONFIG_auth_providers_zitadel_teamPrefix: "team-"
      APP_CONFIG_auth_providers_zitadel_groupDomain: "default"
      
      # Kubernetes plugin
      APP_CONFIG_kubernetes_serviceLocatorMethod_type: multiTenant
      APP_CONFIG_kubernetes_clusterLocatorMethods_0_type: config
      APP_CONFIG_kubernetes_clusterLocatorMethods_0_clusters_0_name: local-mock
      APP_CONFIG_kubernetes_clusterLocatorMethods_0_clusters_0_url: http://mock-k8s:8080
      APP_CONFIG_kubernetes_clusterLocatorMethods_0_clusters_0_authProvider: serviceAccount
      APP_CONFIG_kubernetes_clusterLocatorMethods_0_clusters_0_skipTLSVerify: true
      
      # VictoriaMetrics/VictoriaLogs
      APP_CONFIG_victoriametrics_metricsUrl: http://victoriametrics:8428
      APP_CONFIG_victoriametrics_logsUrl: http://victoriametrics:9428
      APP_CONFIG_victoriametrics_queryPath: /select/logsql/query
      APP_CONFIG_victoriametrics_insertPath: /insert/jsonline
      
      # PostgreSQL
      APP_CONFIG_backend_database_connection_host: postgres
      APP_CONFIG_backend_database_connection_port: 5432
      APP_CONFIG_backend_database_connection_user: postgres
      APP_CONFIG_backend_database_connection_password: postgres
      APP_CONFIG_backend_database_connection_database: backstage
      
      # Permission policy
      APP_CONFIG_permission_enabled: true
      APP_CONFIG_permission_kubernetes_sharedNamespaces_0: monitoring
      APP_CONFIG_permission_kubernetes_sharedNamespaces_1: platform-tools
      APP_CONFIG_permission_kubernetes_sharedNamespaces_2: flux-system
      APP_CONFIG_permission_kubernetes_enableAuditLogging: true
      APP_CONFIG_permission_kubernetes_strictMode: true
      
      # Hot-reload (development)
      CHOKIDAR_USEPOLLING: "true"
      WATCHPACK_POLLING: "true"
    depends_on:
      postgres:
        condition: service_healthy
      zitadel-init:
        condition: service_completed_successfully
      victoriametrics:
        condition: service_healthy
      mock-k8s:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:7007/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    <<: *logging
    networks:
      - backstage-network

# ==========================================
# Volumes
# ==========================================
volumes:
  postgres-data:
    driver: local
  victoriametrics-data:
    driver: local

# ==========================================
# Networks
# ==========================================
networks:
  backstage-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
